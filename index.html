<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Trader X Mini Exchange – BTC/IDR</title>
  <style>
    :root {
      --bg:#0b0f14; --panel:#121824; --accent:#00e0a4; --accent2:#6ea8fe;
      --text:#e6edf3; --muted:#9aa7b2; --danger:#ff5c7a; --good:#23d18b;
    }
    body { background:var(--bg); color:var(--text); font-family:Inter,system-ui,Arial; margin:0; }
    header { padding:16px 20px; display:flex; align-items:center; gap:12px; border-bottom:1px solid #1c2330; }
    header h1 { font-size:18px; margin:0; letter-spacing:0.3px; }
    header .pair { color:var(--muted); font-weight:600; }
    .container { padding:20px; display:grid; grid-template-columns: 1.1fr 0.9fr; gap:20px; }
    .panel { background:var(--panel); border:1px solid #1c2330; border-radius:12px; }
    .panel h2 { margin:0; padding:12px 14px; font-size:14px; border-bottom:1px solid #1c2330; color:var(--muted); }
    .content { padding:14px; }
    .row { display:flex; gap:14px; }
    .col { flex:1; }
    label { display:block; font-size:12px; color:var(--muted); margin-bottom:6px; }
    input, select { width:100%; padding:10px; border-radius:8px; border:1px solid #283042; background:#0f1420; color:var(--text); }
    .btn { padding:10px 12px; border:none; border-radius:8px; font-weight:600; cursor:pointer; }
    .btn.buy { background:var(--good); color:#07150f; }
    .btn.sell { background:var(--danger); color:#2b0a11; }
    .btn.secondary { background:#1c2330; color:var(--text); border:1px solid #283042; }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    .metrics { display:flex; gap:18px; flex-wrap:wrap; }
    .metric { background:#0f1420; border:1px solid #283042; border-radius:10px; padding:10px 12px; }
    .metric .label { font-size:11px; color:var(--muted); }
    .metric .value { font-size:16px; font-weight:700; margin-top:4px; }
    table { width:100%; border-collapse: collapse; }
    th, td { font-size:12px; padding:8px; border-bottom:1px solid #1c2330; }
    th { color:var(--muted); text-align:left; }
    .asks tr td { color:#ff8fa1; }
    .bids tr td { color:#7dffbf; }
    .flex { display:flex; gap:10px; align-items:center; }
    .justify { display:flex; justify-content:space-between; align-items:center; }
    .price { font-size:20px; font-weight:800; color:var(--accent); }
    .muted { color:var(--muted); }
    .footer { padding:0 20px 20px; }
    .tag { font-size:11px; color:#b9c3cf; background:#0f1420; border:1px dashed #2a3244; padding:6px 8px; border-radius:8px; display:inline-block; }
    @media (max-width:900px){ .container{ grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <header>
    <h1>Trader X • Mini Exchange</h1>
    <div class="pair">Pair: BTC/IDR</div>
    <div class="tag">Simulasi lokal (no backend)</div>
  </header>

  <div class="container">
    <!-- Left: Trading -->
    <div class="panel">
      <h2>Trading panel</h2>
      <div class="content">
        <div class="metrics">
          <div class="metric"><div class="label">Last price (IDR)</div><div class="value" id="lastPrice">—</div></div>
          <div class="metric"><div class="label">Best bid</div><div class="value" id="bestBid">—</div></div>
          <div class="metric"><div class="label">Best ask</div><div class="value" id="bestAsk">—</div></div>
        </div>

        <div class="grid" style="margin-top:12px;">
          <div>
            <div class="justify">
              <div class="muted">Order type</div>
              <div class="muted">Side</div>
            </div>
            <div class="flex">
              <select id="orderType">
                <option value="market">Market</option>
                <option value="limit">Limit</option>
              </select>
              <select id="orderSide">
                <option value="buy">Buy</option>
                <option value="sell">Sell</option>
              </select>
            </div>
            <div class="row" style="margin-top:10px;">
              <div class="col">
                <label>Harga (IDR) — limit only</label>
                <input type="number" id="price" placeholder="contoh: 950000000" />
              </div>
              <div class="col">
                <label>Qty (BTC)</label>
                <input type="number" id="qty" placeholder="contoh: 0.01" />
              </div>
            </div>
            <div class="flex" style="margin-top:12px;">
              <button class="btn buy" id="placeBuy">Place BUY</button>
              <button class="btn sell" id="placeSell">Place SELL</button>
              <button class="btn secondary" id="reset">Reset</button>
            </div>
          </div>

          <div>
            <div class="metrics">
              <div class="metric">
                <div class="label">Saldo IDR</div>
                <div class="value" id="balIDR">—</div>
              </div>
              <div class="metric">
                <div class="label">Saldo BTC</div>
                <div class="value" id="balBTC">—</div>
              </div>
            </div>
            <div class="muted" style="margin-top:8px;">Fee taker 0.1%, maker 0.0% (simulasi)</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Right: Orderbook & trades -->
    <div class="panel">
      <h2>Order book & trades</h2>
      <div class="content">
        <div class="grid">
          <div>
            <div class="muted">Asks (sell orders)</div>
            <table class="asks">
              <thead><tr><th>Harga</th><th>Qty</th></tr></thead>
              <tbody id="asksBody"></tbody>
            </table>
          </div>
          <div>
            <div class="muted">Bids (buy orders)</div>
            <table class="bids">
              <thead><tr><th>Harga</th><th>Qty</th></tr></thead>
              <tbody id="bidsBody"></tbody>
            </table>
          </div>
        </div>

        <div style="margin-top:12px;">
          <div class="muted">Trade history</div>
          <table>
            <thead><tr><th>Waktu</th><th>Side</th><th>Harga</th><th>Qty</th><th>Nilai (IDR)</th></tr></thead>
            <tbody id="tradesBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <div class="footer">
    <div class="tag">Tips: isi order book dulu pakai limit order, lalu eksekusi market biar kebayang matching engine-nya.</div>
  </div>

  <script>
    // State
    const state = {
      balance: { IDR: 100_000_000, BTC: 0.05 }, // default saldo
      bids: [], // buy orders: highest price first
      asks: [], // sell orders: lowest price first
      trades: [],
      lastPrice: null,
      fees: { taker: 0.001, maker: 0.0 }
    };

    // Utils
    const fmtIDR = v => new Intl.NumberFormat('id-ID', { style:'currency', currency:'IDR', maximumFractionDigits:0 }).format(v);
    const fmtBTC = v => Number(v).toFixed(8);
    const now = () => new Date().toLocaleTimeString('id-ID', { hour12:false });

    // UI refs
    const el = {
      lastPrice: document.getElementById('lastPrice'),
      bestBid: document.getElementById('bestBid'),
      bestAsk: document.getElementById('bestAsk'),
      balIDR: document.getElementById('balIDR'),
      balBTC: document.getElementById('balBTC'),
      bidsBody: document.getElementById('bidsBody'),
      asksBody: document.getElementById('asksBody'),
      tradesBody: document.getElementById('tradesBody'),
      orderType: document.getElementById('orderType'),
      orderSide: document.getElementById('orderSide'),
      price: document.getElementById('price'),
      qty: document.getElementById('qty'),
      placeBuy: document.getElementById('placeBuy'),
      placeSell: document.getElementById('placeSell'),
      reset: document.getElementById('reset'),
    };

    function render() {
      // Balances
      el.balIDR.textContent = fmtIDR(state.balance.IDR);
      el.balBTC.textContent = fmtBTC(state.balance.BTC) + ' BTC';

      // Orderbook
      state.bids.sort((a,b)=> b.price - a.price || a.ts - b.ts);
      state.asks.sort((a,b)=> a.price - b.price || a.ts - b.ts);

      el.bidsBody.innerHTML = state.bids.map(o =>
        `<tr><td>${fmtIDR(o.price)}</td><td>${fmtBTC(o.qty)}</td></tr>`
      ).join('');

      el.asksBody.innerHTML = state.asks.map(o =>
        `<tr><td>${fmtIDR(o.price)}</td><td>${fmtBTC(o.qty)}</td></tr>`
      ).join('');

      // Best bid/ask & last
      const bestBid = state.bids[0]?.price ?? null;
      const bestAsk = state.asks[0]?.price ?? null;
      el.bestBid.textContent = bestBid ? fmtIDR(bestBid) : '—';
      el.bestAsk.textContent = bestAsk ? fmtIDR(bestAsk) : '—';
      el.lastPrice.textContent = state.lastPrice ? fmtIDR(state.lastPrice) : '—';

      // Trades
      el.tradesBody.innerHTML = state.trades.slice().reverse().map(t =>
        `<tr>
          <td>${t.time}</td>
          <td>${t.side.toUpperCase()}</td>
          <td>${fmtIDR(t.price)}</td>
          <td>${fmtBTC(t.qty)}</td>
          <td>${fmtIDR(t.price * t.qty)}</td>
        </tr>`
      ).join('');
    }

    function addOrder({ side, price, qty, maker=true }) {
      if(qty <= 0 || price <= 0) return;
      const order = { side, price, qty, ts: performance.now() };

      // Try match immediately
      if(side === 'buy') {
        // match against best asks
        while(order.qty > 0 && state.asks.length) {
          const best = state.asks[0];
          if(best.price > order.price) break; // only match if ask <= buy price

          const tradable = Math.min(order.qty, best.qty);
          const fee = (maker ? state.fees.maker : state.fees.taker) * best.price * tradable;

          // Check balance IDR for buyer
          const cost = best.price * tradable + (maker ? 0 : fee);
          if(state.balance.IDR < cost && side === 'buy') break;

          // Execute
          state.balance.IDR -= cost;
          state.balance.BTC += tradable;

          // Seller receives IDR (no fee deducted in this simple model for maker)
          // We don't model individual seller balances in this demo.

          best.qty -= tradable;
          order.qty -= tradable;

          recordTrade({ side:'buy', price: best.price, qty: tradable });
          if(best.qty <= 0) state.asks.shift();
        }
        // leftover goes to book
        if(order.qty > 0) {
          // place as bid
          state.bids.push({ price: order.price, qty: order.qty, ts: order.ts });
        }
      } else {
        // side === 'sell', match against best bids
        while(order.qty > 0 && state.bids.length) {
          const best = state.bids[0];
          if(best.price < order.price) break; // only match if bid >= sell price

          const tradable = Math.min(order.qty, best.qty);
          const fee = (maker ? state.fees.maker : state.fees.taker) * best.price * tradable;

          // Check balance BTC for seller
          if(state.balance.BTC < tradable) break;

          const proceeds = best.price * tradable - (maker ? 0 : fee);

          // Execute
          state.balance.BTC -= tradable;
          state.balance.IDR += proceeds;

          best.qty -= tradable;
          order.qty -= tradable;

          recordTrade({ side:'sell', price: best.price, qty: tradable });
          if(best.qty <= 0) state.bids.shift();
        }
        // leftover goes to book
        if(order.qty > 0) {
          state.asks.push({ price: order.price, qty: order.qty, ts: order.ts });
        }
      }
      render();
    }

    function executeMarket({ side, qty }) {
      if(qty <= 0) return;
      if(side === 'buy') {
        // consume asks from lowest price
        while(qty > 0 && state.asks.length) {
          const ask = state.asks[0];
          const take = Math.min(qty, ask.qty);
          const fee = state.fees.taker * ask.price * take;
          const cost = ask.price * take + fee;

          if(state.balance.IDR < cost) break;

          state.balance.IDR -= cost;
          state.balance.BTC += take;

          ask.qty -= take;
          qty -= take;
          recordTrade({ side:'buy', price: ask.price, qty: take });
          if(ask.qty <= 0) state.asks.shift();
        }
      } else {
        // sell into bids from highest price
        while(qty > 0 && state.bids.length) {
          const bid = state.bids[0];
          const take = Math.min(qty, bid.qty);
          const fee = state.fees.taker * bid.price * take;
          const proceeds = bid.price * take - fee;

          if(state.balance.BTC < take) break;

          state.balance.BTC -= take;
          state.balance.IDR += proceeds;

          bid.qty -= take;
          qty -= take;
          recordTrade({ side:'sell', price: bid.price, qty: take });
          if(bid.qty <= 0) state.bids.shift();
        }
      }
      render();
    }

    function recordTrade(t) {
      state.lastPrice = t.price;
      state.trades.push({ time: now(), ...t });
    }

    // Seed book with sample liquidity
    function seedBook() {
      state.bids = [
        { price: 940_000_000, qty: 0.015, ts: performance.now() },
        { price: 935_000_000, qty: 0.020, ts: performance.now()+1 },
        { price: 930_000_000, qty: 0.030, ts: performance.now()+2 },
      ];
      state.asks = [
        { price: 960_000_000, qty: 0.010, ts: performance.now() },
        { price: 965_000_000, qty: 0.020, ts: performance.now()+1 },
        { price: 970_000_000, qty: 0.025, ts: performance.now()+2 },
      ];
      state.lastPrice = 950_000_000;
    }

    function resetAll() {
      state.balance = { IDR: 100_000_000, BTC: 0.05 };
      state.trades = [];
      seedBook();
      render();
    }

    // Events
    el.placeBuy.addEventListener('click', () => {
      const type = el.orderType.value;
      const qty = parseFloat(el.qty.value || '0');
      if(type === 'market') {
        executeMarket({ side:'buy', qty });
      } else {
        const price = parseFloat(el.price.value || '0');
        addOrder({ side:'buy', price, qty, maker:true });
      }
    });

    el.placeSell.addEventListener('click', () => {
      const type = el.orderType.value;
      const qty = parseFloat(el.qty.value || '0');
      if(type === 'market') {
        executeMarket({ side:'sell', qty });
      } else {
        const price = parseFloat(el.price.value || '0');
        addOrder({ side:'sell', price, qty, maker:true });
      }
    });

    el.reset.addEventListener('click', resetAll);

    // Init
    resetAll();
  </script>
</body>
</html>